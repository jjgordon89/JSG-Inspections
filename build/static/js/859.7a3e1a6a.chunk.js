"use strict";(self.webpackChunkjsg_inspections=self.webpackChunkjsg_inspections||[]).push([[859],{5859:(e,i,n)=>{n.r(i),n.d(i,{default:()=>c});var r=n(5043),t=n(4107),s=n(579);const c=function(){const{currentUser:e}=(0,t.J)(),[i,n]=(0,r.useState)([]),[c,a]=(0,r.useState)([]),[o,d]=(0,r.useState)("all"),[l,u]=(0,r.useState)(!0),[v,m]=(0,r.useState)(!1),[p,h]=(0,r.useState)({equipmentId:"",severity:"minor",removeFromService:!1,description:"",component:"",correctiveAction:"",dueDate:""});(0,r.useEffect)(()=>{f()},[o]);const f=async()=>{try{u(!0);const[e,i]=await Promise.all(["all"===o?window.api.deficiencies.getAll():window.api.deficiencies.getByStatus(o),window.api.equipment.getAll()]);n(e),a(i)}catch(e){console.error("Error loading data:",e)}finally{u(!1)}},y=async()=>{try{let e;u(!0),e="all"===o?await window.api.deficiencies.getAll():await window.api.deficiencies.getByStatus(o),n(e)}catch(e){console.error("Error fetching deficiencies:",e)}finally{u(!1)}},g=async(n,r)=>{try{const t=i.find(e=>e.id===n);if(!t)return;const s=t.status;await window.api.deficiencies.update({id:n,severity:t.severity,removeFromService:t.remove_from_service,description:t.description,component:t.component,correctiveAction:t.corrective_action,dueDate:t.due_date,status:r}),await window.api.auditLog.create({userId:(null===e||void 0===e?void 0:e.id)||null,username:(null===e||void 0===e?void 0:e.username)||"Unknown User",action:"update",entityType:"deficiency",entityId:n,oldValues:JSON.stringify({status:s}),newValues:JSON.stringify({status:r}),ipAddress:null,userAgent:navigator.userAgent}),y()}catch(t){console.error("Error updating deficiency status:",t),alert("Failed to update deficiency status. Please try again.")}},j=e=>{switch(e){case"critical":return"#dc3545";case"major":return"#fd7e14";case"minor":return"#ffc107";default:return"#6c757d"}},x=e=>{switch(e){case"open":return"#dc3545";case"in_progress":return"#ffc107";case"verified":return"#17a2b8";case"closed":return"#28a745";default:return"#6c757d"}},w=e=>e?new Date(e).toLocaleDateString():"Not set";return l?(0,s.jsx)("div",{className:"deficiencies-loading",children:"Loading deficiencies..."}):(0,s.jsxs)("div",{className:"deficiencies",children:[(0,s.jsxs)("div",{className:"deficiencies-header",children:[(0,s.jsx)("h2",{children:"Deficiency Management"}),(0,s.jsxs)("div",{className:"header-actions",children:[(0,s.jsxs)("div",{className:"deficiencies-filters",children:[(0,s.jsx)("label",{children:"Filter by status:"}),(0,s.jsxs)("select",{value:o,onChange:e=>d(e.target.value),children:[(0,s.jsx)("option",{value:"all",children:"All Deficiencies"}),(0,s.jsx)("option",{value:"open",children:"Open"}),(0,s.jsx)("option",{value:"in_progress",children:"In Progress"}),(0,s.jsx)("option",{value:"verified",children:"Verified"}),(0,s.jsx)("option",{value:"closed",children:"Closed"})]})]}),(0,s.jsx)("button",{className:"create-button",onClick:()=>m(!0),children:"+ Create Deficiency"})]})]}),0===i.length?(0,s.jsx)("div",{className:"no-deficiencies",children:(0,s.jsx)("p",{children:"No deficiencies found for the selected filter."})}):(0,s.jsx)("div",{className:"deficiencies-grid",children:i.map(i=>(0,s.jsxs)("div",{className:"deficiency-card",children:[(0,s.jsxs)("div",{className:"deficiency-header",children:[(0,s.jsxs)("div",{className:"deficiency-badges",children:[(0,s.jsx)("span",{className:"severity-badge",style:{backgroundColor:j(i.severity)},children:i.severity.toUpperCase()}),(0,s.jsx)("span",{className:"status-badge",style:{backgroundColor:x(i.status)},children:i.status.replace("_"," ").toUpperCase()}),i.remove_from_service&&(0,s.jsx)("span",{className:"oos-badge",children:"OUT OF SERVICE"})]}),(0,s.jsxs)("div",{className:"deficiency-id",children:["#",i.id]})]}),(0,s.jsxs)("div",{className:"deficiency-details",children:[(0,s.jsxs)("h4",{children:["Equipment: ",i.equipment_identifier]}),i.component&&(0,s.jsxs)("p",{children:[(0,s.jsx)("strong",{children:"Component:"})," ",i.component]}),(0,s.jsxs)("p",{children:[(0,s.jsx)("strong",{children:"Description:"})," ",i.description]}),i.corrective_action&&(0,s.jsxs)("p",{children:[(0,s.jsx)("strong",{children:"Corrective Action:"})," ",i.corrective_action]}),(0,s.jsxs)("p",{children:[(0,s.jsx)("strong",{children:"Created:"})," ",w(i.created_at)]}),i.due_date&&(0,s.jsxs)("p",{children:[(0,s.jsx)("strong",{children:"Due Date:"})," ",w(i.due_date)]}),i.closed_at&&(0,s.jsxs)("p",{children:[(0,s.jsx)("strong",{children:"Closed:"})," ",w(i.closed_at)]})]}),(0,s.jsxs)("div",{className:"deficiency-actions",children:["open"===i.status&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("button",{onClick:()=>g(i.id,"in_progress"),className:"progress-btn",children:"Start Work"}),(0,s.jsx)("button",{onClick:()=>(async i=>{try{const n=c.find(e=>e.id===i.equipment_id);if(!n)return void alert("Equipment not found");const r=`DEF-${n.equipment_id}-${(new Date).getFullYear()}-${String(Date.now()).slice(-4)}`,t={equipmentId:i.equipment_id,woNumber:r,title:`Deficiency Repair - ${i.component||n.equipment_id}`,description:`${i.description}\n\nCorrective Action: ${i.corrective_action||"To be determined"}`,workType:"corrective",priority:"critical"===i.severity?"critical":"major"===i.severity?"high":"medium",assignedTo:null,estimatedHours:null,createdBy:(null===e||void 0===e?void 0:e.full_name)||"Unknown User",scheduledDate:i.due_date,deficiencyId:i.id},s=await window.api.workOrders.create(t),a=(null===s||void 0===s?void 0:s.lastID)||(null===s||void 0===s?void 0:s.id)||0;await window.api.deficiencies.linkToWorkOrder(i.id,a),await window.api.auditLog.create({userId:(null===e||void 0===e?void 0:e.id)||null,username:(null===e||void 0===e?void 0:e.username)||"Unknown User",action:"create",entityType:"work_order",entityId:a,oldValues:null,newValues:JSON.stringify(t),ipAddress:null,userAgent:navigator.userAgent}),await window.api.auditLog.create({userId:(null===e||void 0===e?void 0:e.id)||null,username:(null===e||void 0===e?void 0:e.username)||"Unknown User",action:"link",entityType:"deficiency",entityId:i.id,oldValues:JSON.stringify({work_order_id:null}),newValues:JSON.stringify({work_order_id:a}),ipAddress:null,userAgent:navigator.userAgent}),alert(`Work Order ${r} created and linked to deficiency!`),await f()}catch(n){console.error("Error creating work order from deficiency:",n),alert("Failed to create work order. Please try again.")}})(i),className:"create-wo-btn",children:"Create Work Order"})]}),"in_progress"===i.status&&(0,s.jsx)("button",{onClick:()=>g(i.id,"verified"),className:"verify-btn",children:"Mark Verified"}),"verified"===i.status&&(0,s.jsx)("button",{onClick:()=>(async i=>{try{const n=(null===e||void 0===e?void 0:e.full_name)||"Unknown User";await window.api.deficiencies.close(i,n),await window.api.auditLog.create({userId:(null===e||void 0===e?void 0:e.id)||null,username:(null===e||void 0===e?void 0:e.username)||"Unknown User",action:"close",entityType:"deficiency",entityId:i,oldValues:JSON.stringify({status:"verified"}),newValues:JSON.stringify({status:"closed",verificationSignature:n}),ipAddress:null,userAgent:navigator.userAgent}),y()}catch(n){console.error("Error closing deficiency:",n),alert("Failed to close deficiency. Please try again.")}})(i.id),className:"close-btn",children:"Close Deficiency"}),"closed"!==i.status&&(0,s.jsx)("button",{onClick:()=>{alert("Edit functionality would be implemented here")},className:"edit-btn",children:"Edit"})]})]},i.id))}),v&&(0,s.jsx)("div",{className:"modal-overlay",children:(0,s.jsxs)("div",{className:"modal-content",children:[(0,s.jsxs)("div",{className:"modal-header",children:[(0,s.jsx)("h2",{children:"Create Deficiency"}),(0,s.jsx)("button",{className:"close-button",onClick:()=>m(!1),children:"\xd7"})]}),(0,s.jsxs)("form",{onSubmit:async i=>{i.preventDefault();try{const i=await window.api.deficiencies.create({equipmentId:parseInt(p.equipmentId),inspectionItemId:null,severity:p.severity,removeFromService:p.removeFromService,description:p.description,component:p.component,correctiveAction:p.correctiveAction,dueDate:p.dueDate||null,status:"open"}),n=(null===i||void 0===i?void 0:i.lastID)||(null===i||void 0===i?void 0:i.id)||0;await window.api.auditLog.create({userId:(null===e||void 0===e?void 0:e.id)||null,username:(null===e||void 0===e?void 0:e.username)||"Unknown User",action:"create",entityType:"deficiency",entityId:n,oldValues:null,newValues:JSON.stringify(p),ipAddress:null,userAgent:navigator.userAgent}),m(!1),h({equipmentId:"",severity:"minor",removeFromService:!1,description:"",component:"",correctiveAction:"",dueDate:""}),await f()}catch(n){console.error("Error creating deficiency:",n),alert("Failed to create deficiency. Please try again.")}},className:"create-form",children:[(0,s.jsxs)("div",{className:"form-row",children:[(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsx)("label",{children:"Equipment *"}),(0,s.jsxs)("select",{value:p.equipmentId,onChange:e=>h({...p,equipmentId:e.target.value}),required:!0,children:[(0,s.jsx)("option",{value:"",children:"Select Equipment"}),c.map(e=>(0,s.jsxs)("option",{value:e.id,children:[e.equipment_id," - ",e.type]},e.id))]})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsx)("label",{children:"Severity *"}),(0,s.jsxs)("select",{value:p.severity,onChange:e=>h({...p,severity:e.target.value}),required:!0,children:[(0,s.jsx)("option",{value:"minor",children:"Minor"}),(0,s.jsx)("option",{value:"major",children:"Major"}),(0,s.jsx)("option",{value:"critical",children:"Critical"})]})]})]}),(0,s.jsxs)("div",{className:"form-row",children:[(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsx)("label",{children:"Component"}),(0,s.jsx)("input",{type:"text",value:p.component,onChange:e=>h({...p,component:e.target.value}),placeholder:"e.g., Hydraulic System, Wire Rope, Hook Block"})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsx)("label",{children:"Due Date"}),(0,s.jsx)("input",{type:"date",value:p.dueDate,onChange:e=>h({...p,dueDate:e.target.value})})]})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsx)("label",{children:"Description *"}),(0,s.jsx)("textarea",{value:p.description,onChange:e=>h({...p,description:e.target.value}),required:!0,rows:"3",placeholder:"Detailed description of the deficiency"})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsx)("label",{children:"Corrective Action"}),(0,s.jsx)("textarea",{value:p.correctiveAction,onChange:e=>h({...p,correctiveAction:e.target.value}),rows:"3",placeholder:"Required corrective action to resolve the deficiency"})]}),(0,s.jsx)("div",{className:"form-group",children:(0,s.jsxs)("label",{className:"checkbox-label",children:[(0,s.jsx)("input",{type:"checkbox",checked:p.removeFromService,onChange:e=>h({...p,removeFromService:e.target.checked})}),"Remove equipment from service"]})}),(0,s.jsxs)("div",{className:"form-actions",children:[(0,s.jsx)("button",{type:"button",onClick:()=>m(!1),className:"cancel-button",children:"Cancel"}),(0,s.jsx)("button",{type:"submit",className:"submit-button",children:"Create Deficiency"})]})]})]})})]})}}}]);
//# sourceMappingURL=859.7a3e1a6a.chunk.js.map